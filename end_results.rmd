Overlap between our results and Volinia et al.
========================================================
`r as.character(Sys.time())`

```{r time, echo=FALSE}
starttime = Sys.time()
# copy and move an older version of the html file that will be produced
oldfn = "end_results.html"
if(file.exists(oldfn))
  {
    datestr = strsplit( as.character(file.info(oldfn)$ctime), " ")[[1]][1]
    backupname = sub(".html", paste("_",datestr, ".html", sep=""), oldfn)
    backupname = paste("not_in_github/", backupname, sep="")
    if(file.exists(backupname))
		{
			file.remove(backupname)
		}
    x=file.copy(oldfn,backupname, overwrite=TRUE )   
  }
```
<br/>
<br/>

We will check for

- concordance between our two approaches called **meta** and **merged**
- concordance between our results and Volinia et al.
- microRNA evidence status for the results

<BR/>
<BR/>
Read in prepared data.

```{r message=FALSE}
library(xtable)
if(!exists("inputisread"))
	source("read_input.r")
postfix = ".csv"
separator=","
options(digits=4)
outputdir = "output-analysis"
divdir = paste(outputdir, "/div", sep="")
if(!file.exists(divdir))
	dir.create(divdir)
articledir = paste(outputdir, "/used_in_article", sep="")
if(!file.exists(articledir))
	dir.create(articledir)
supplementaryfile1dir = paste(articledir, "/additionalfile1", sep="")
if(!file.exists(supplementaryfile1dir))
	dir.create(supplementaryfile1dir)

fdrCO = 0.05
```
<br/>
<br/>

## Meta vs Merged results.

Our data sets came from two providers, "**AHUS**" and "**METABRIC**" (sometimes called "UCAM"), using two different Agilent microRNA platforms. Batch effects were present as visualized in the QC report. We tested for differentially expressed genes using two approaches, combining all data in Limma using provider as a blocking factor ("**merged**" approach), and  analyzing the two sets independently with Limma and combine based on the p-values ("**meta**" approach).

Here we will list the agreement between the two approaches.

First a recap of the number of samples and grouping based on annotation.

Sample count based on tissue type and provider.

```{r results='asis'}
print(xtable(table(sampleannotation[, c("provider" ,"tissue_type")]), 
             caption="", digits=3), 
      comment = TRUE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
```
<br/>
<br/>
Sample count based on PAM50 classification in each tissue and from each provider:

```{r results='asis'}
for(p in unique(sampleannotation$provider))
{

	print(xtable(table(sampleannotation[sampleannotation$provider==p &
																			sampleannotation$tissue_type %in% c("DCIS", "invasive")	, 
																			c("tissue_type" ,"pam50_est")]), 
             caption=p, digits=3), 
      comment = TRUE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
}
```

Due to the low number of DCIS samples, the pam50 classification were disregarded for those. The comparisons made, were between DCIS samples and the different pam50 classifications of invasive samples. Benign and normal samples were not used in these comparisons.
<br/>
<br/>
Sample count based on IHC diagnosis in each tissue and from each provider

```{r results='asis'}
for(p in unique(sampleannotation$provider))
{

	print(xtable(table(sampleannotation[sampleannotation$provider==p , c("tissue_type" ,"IHC")]), 
             caption=p, digits=3), 
      comment = TRUE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
}
```

Again, due to the low number of DCIS samples, the IHC diagnoses were disregarded for those. The comparisons made, were between DCIS samples and the different IHC diagnoses of invasive samples. Benign and normal samples were not used in these comparisons either.


<br/>
<br/>
```{r results='asis'}
# creating table1 our in article.
notbenign = !sampleannotation$tissue_type=="benign"
invasiveonly = sampleannotation$tissue_type=="invasive"
a=table(sampleannotation[notbenign, c("tissue_type", "provider")])
b=table(sampleannotation[invasiveonly, c("pam50_est", "provider")])
c=table(sampleannotation[invasiveonly, c("IHC", "provider")])
table1 = rbind(a[c("normal", "DCIS", "invasive"),], 
							 b[c("LumA", "LumB", "Her2", "Basallike", "Normallike"),],
							 c[c("HER2neg_ERpos", "HER2pos_ERpos", "HER2pos_ERneg", "HER2neg_ERneg_PGRneg"),],
							 total=colSums(a))
write.table(table1, file=paste(articledir, "/table1", postfix, sep=""), sep=separator, col.names=NA, quote=FALSE)

```

Read in our results from files.

```{r}

#metafilefolder = "not_in_github/lilianas"
metafilefolder = "output-analysis/difflists_meta"
mergedfilefolder = "output-analysis/difflists_merged"

meta2merged = data.frame(metafn=character(0), mergedfn=character(0), direction=numeric(0), comparisontype=character(0), stringsAsFactors=FALSE)
meta2merged["DCIS-normal",] = list("DCIS_to_normal_limma.txt", "difflist-DCIS-vs-normal.txt",-1, "tissue")
meta2merged["invasive-DCIS",] = list("DCIS_to_invasive_limma.txt", "difflist-invasive-vs-DCIS.txt",1, "tissue")
meta2merged["Normallike-DCIS",] = list("dcis_to_normallike_limma.txt", "difflist-pam50-Normallike-vs-DCIS.txt",1, "pam50")
meta2merged["LumA-DCIS",] = list("dcis_to_lumA_limma.txt", "difflist-pam50-LumA-vs-DCIS.txt",1, "pam50")
meta2merged["LumB-DCIS",] = list("dcis_to_lumB_limma.txt", "difflist-pam50-LumB-vs-DCIS.txt",1, "pam50")
meta2merged["Her2-DCIS",] = list("dcis_to_her2_limma.txt", "difflist-pam50-Her2-vs-DCIS.txt",1, "pam50")
meta2merged["Basallike-DCIS",] = list("basallike_to_dcis_limma.txt", "difflist-pam50-Basallike-vs-DCIS.txt",-1, "pam50")
meta2merged["HER2neg_ERneg_PGRneg-DCIS",] = list("dcis_to_HER2neg_ERneg_PGRneg_limma.txt", "difflist-IHC-HER2neg_ERneg_PGRneg-vs-DCIS.txt",1, "IHC")
meta2merged["HER2neg_ERpos-DCIS",] = list("dcis_to_HER2neg_ERpos_limma.txt", "difflist-IHC-HER2neg_ERpos-vs-DCIS.txt",1, "IHC")
meta2merged["HER2pos_ERneg-DCIS",] = list("dcis_to_HER2pos_ERneg_limma.txt", "difflist-IHC-HER2pos_ERneg-vs-DCIS.txt",1, "IHC")
meta2merged["HER2pos_ERpos-DCIS",] = list("dcis_to_HER2pos_ERpos_limma.txt", "difflist-IHC-HER2pos_ERpos-vs-DCIS.txt",1, "IHC")

metatables = list()
mergedtables = list()
consensustables = list()
summarytab = data.frame( found_meta=integer(0),  found_merged=integer(0), 
                       found_both=integer(0),  stringsAsFactors=FALSE)

for(i in 1:nrow(meta2merged))
{   
    thiscomp = rownames(meta2merged)[i]
    fn = paste(metafilefolder, "/", meta2merged[thiscomp, "metafn"], sep="")
    if(file.info(fn)$size>10)
    	{
    thismetatab = read.table(fn, sep="\t", header=TRUE, stringsAsFactors=FALSE, fill=TRUE,
                                     strip.white=TRUE, comment.char ="")
    } else{
    	thismetatab = thismetatab[0,] # workaround to deal with empty files from meta.
    }
    fn = paste(mergedfilefolder, "/", meta2merged[thiscomp, "mergedfn"], sep="")
    thismergedtab = read.table(fn, sep="\t", header=TRUE, stringsAsFactors=FALSE, fill=TRUE,
                                     strip.white=TRUE, comment.char ="", row.names=1)
    
    #harmonizing a little
    rownames(thismetatab) = thismetatab$MIMAT
    thismetatab$TestStatistic = thismetatab$TestStatistic * meta2merged[thiscomp, "direction"]
  #summarytab[thiscomp, "metafile"] = rownames(thisrows)[1]
  #summarytab[thiscomp, "mergedfile"] = thisrows[1, "mergedfn"]

  a = thismetatab$adj.P.Val <= 0.05
  summarytab[thiscomp, "found_meta"] =sum(a)
  b = thismergedtab$adj.P.Val <= 0.05
  summarytab[thiscomp, "found_merged"] = sum(b)
  
  commonMIMATID = intersect( rownames(thismetatab)[a],  rownames(thismergedtab)[b])
  summarytab[thiscomp, "found_both"] = sum( thismetatab[commonMIMATID, "TestStatistic"] * thismergedtab[commonMIMATID, "logFC"] > 0) 
  summarytab[thiscomp, "wrong_direction"] = sum( thismetatab[commonMIMATID, "TestStatistic"] * thismergedtab[commonMIMATID, "logFC"] < 0) 
  rm(commonMIMATID)
  metatables[[thiscomp]] = thismetatab
  mergedtables[[thiscomp]] = thismergedtab
  
  x = mergedtables[[thiscomp]][, c("logFC", "adj.P.Val")]
  y = metatables[[thiscomp]][, c("TestStatistic", "adj.P.Val")]
  names(x) = paste(names(x), ".merged", sep="")
  names(y) = paste(names(y), ".meta", sep="")
  
 	thistable = merge(x, y, by.x = "row.names", by.y="row.names",  all.x=TRUE)
  row.names(thistable) = thistable$Row.names
  thistable = cbind(MIMAT = thistable$Row.names, name=miRNA2MIMAT[thistable$Row.names, "preferredname"], thistable[,-1])
  thistable$same_dir =  (thistable$logFC.merged * thistable$TestStatistic.meta ) > 0
  thistable$consensus = thistable$adj.P.Val.merged <= 0.05 & 
  	thistable$adj.P.Val.meta <= 0.05 & thistable$same_dir
  consensustables[[thiscomp]] = thistable[order(thistable$consensus, -thistable$adj.P.Val.merged, decreasing=TRUE),]
}

if(sum(summarytab$wrong_direction)>0)
	warning("Some common microRNAs were found that did not have the same dirrection of change!!")
					


```
The above tables are written to [files](output-analysis/consensus) later.
<br/>
<br/>
Next, summarize the number of microRNAs found differentially expressed between states, according to the two approaches. The direction of fold change is taken into account. 

```{r results='asis'}

	print(xtable(summarytab[,1:3], 
             caption="Overlap between meta and merged", digits=3), 
      comment = TRUE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
#	write.table(summarytab[,1:3], file=paste(supplementaryfile1dir, "/suppltable1", postfix, sep=""), 
#							row.names=TRUE, col.names=NA, sep=separator)

```


For several of the comparisons, the shorter list seems to be mostly included in the longer. We will use the intersect as differentially expressed microRNAs, i.e a microRNA is deemed differentially expressed if it is within 0.05 FDR in both the meta and merged analyses.
<br/>
<br/>

Next, a table is written to file with all the expressed (not filtered out) microRNAs listed and whether they were found to be up regulated or down regulated in the different comparisons.

```{r}
signchangetab = as.data.frame(matrix( nrow=nrow(consensustables[[1]]), 
																			ncol=length(consensustables)+2), stringsAsFactors=FALSE)
colnames(signchangetab) = c("MIMATID", "name", names(consensustables))
rownames(signchangetab) = rownames(consensustables[[1]])
signchangetab[,"MIMATID"] = consensustables[[1]]$MIMAT
signchangetab[,"name"] = miRNA2MIMAT[consensustables[[1]]$MIMAT, "MIMAT"]

for(n in names(consensustables))
{
	x = consensustables[[n]][rownames(signchangetab),]
	signchangetab[ x$consensus & x$logFC.merged<0, n ] = "DOWN"
	signchangetab[ x$consensus & x$logFC.merged>0, n ] = "UP" 
}
signchangetabfn = paste(divdir, "/signchangetab", postfix, sep="")
write.table(signchangetab, file=signchangetabfn,
            quote=FALSE, sep=separator, row.names=FALSE, col.names=TRUE, na="")
```

[Link to file](`r signchangetabfn`)
<br/>
<br/>
Next, the overlap in findings between the comparisons.

```{r results='asis'}
comps = names(consensustables)
correlationmatrix1 = matrix(nrow=length(comps), ncol=length(comps),dimnames=list(comps,comps))
correlationmatrix2 = correlationmatrix1
for(i in 1:(length(comps)-1))
{
  for(j in (i+1):length(comps))
  {
    correlationmatrix1[i,j] = sum(signchangetab[, comps[i]]==signchangetab[, comps[j]], na.rm=TRUE)
    correlationmatrix1[j,i] = correlationmatrix1[i,j]
    
    correlationmatrix2[i,j] = sum(signchangetab[, comps[i]]!=signchangetab[, comps[j]], na.rm=TRUE)
    correlationmatrix2[j,i] = correlationmatrix2[i,j]
  }

}

correlationmatrixfn = paste(divdir, "/subtypecorrelation", postfix, sep="")
h1 = "Count of significant microRNAs found going in the same direction for the subtypes"
write(h1, file=correlationmatrixfn)
write(paste(separator, colnames(correlationmatrix1), collapse=separator), file=correlationmatrixfn, append=TRUE)
write.table(correlationmatrix1, file=correlationmatrixfn,quote=FALSE, sep=separator, col.names=FALSE, na="X", append=TRUE)
write("\n\n\n", file=correlationmatrixfn, append=TRUE)
h2 = "Count of significant microRNAs found going in the opposite direction for the subtypes"
write(h2, file=correlationmatrixfn, append=TRUE)
write(paste(separator, colnames(correlationmatrix2), collapse=separator), file=correlationmatrixfn, append=TRUE)
write.table(correlationmatrix2, file=correlationmatrixfn,quote=FALSE, sep=separator, col.names=FALSE,  na="X", append=TRUE)

print(xtable(correlationmatrix1, 
             caption=h1, digits=3), 
      comment = TRUE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
```

[Link to file](`r correlationmatrixfn`)

<br/>
<br/>
<br/>

## Our results vs. Volinia et al.´s results

```{r}
volinia_DCIS_vs_normal_file = "volinia-DCIS-vs-normal.txt"
volinia_invasive_vs_DCIS_file = "volinia-invasive-vs-DCIS.txt"
```

`r volinia_DCIS_vs_normal_file` and  `r volinia_invasive_vs_DCIS_file` are copy-pasted from Volinia et al.s [supplementary tables S1 and S2](http://www.pnas.org/content/suppl/2012/02/02/1200010109.DCSupplemental/pnas.201200010SI.pdf). The tables were reformatted from the pdf file into a more practical tabular text format. This is the results we aim to validate with the AHUS and METABRIC data sets.

Read in Volinia results, and do a minor re-formatting.

```{r}

voliniatab = list()
voliniatab[["invasive-DCIS"]] = read.table(file=paste(annotdir, "/", volinia_invasive_vs_DCIS_file, sep=""),
                                      sep="\t", check.names=TRUE, 
                                      stringsAsFactors=FALSE, header=TRUE)
voliniatab[["DCIS-normal"]]  = read.table(file=paste(annotdir, "/", volinia_DCIS_vs_normal_file, sep=""),
                                    sep="\t", check.names=TRUE, 
                                    stringsAsFactors=FALSE, header=TRUE)

for(n in names(voliniatab))
{
	# add a MIMATID 
	voliniatab[[n]] = as.data.frame(append(voliniatab[[n]], 
                  list(MIMATID=miRNA2MIMAT$MIMAT[match(voliniatab[[n]]$miRNA, miRNA2MIMAT$volinia)]), 
                  after=1))
	# use log2 for foldchange in this document.
	voliniatab[[n]]$fc=log2(voliniatab[[n]]$fc)
	names(voliniatab[[n]])[names(voliniatab[[n]])=="fc"] = "log2FC"
	names(voliniatab[[n]])[names(voliniatab[[n]])=="pval"] = "FDR" # this was described as FDR in their paper.
}

```

This is how the tables look now (top only).

```{r}
print(head(voliniatab[[1]]), row.names = FALSE)
```


Compared to the original tables from Volinia, the fold change is here log2 transformed and "IDC" is renamed to "invasive", and the microRNAs are also mapped to MIMATID, which will be used in order to map to our results. 


Count the overlaps of results and make a "validated"-call for each microRNA listed by Volinia et al.

```{r results='asis'}

volinia_overlap = list()

for(contrast in names(voliniatab))
{
	overlaptab = voliniatab[[contrast]]
	overlaptab = overlaptab[!is.na(overlaptab$MIMATID),]
	rownames(overlaptab) = overlaptab$MIMATID
	overlaptab$Direction = ifelse(overlaptab$log2FC > 0, "UP", "DOWN")
	overlaptab = overlaptab[, c("miRNA", "MIMATID", "Direction","FDR")]
	names(overlaptab) = paste(names(overlaptab), "_vol", sep="")
	
	tab = consensustables[[contrast]]
	a = intersect(  rownames(tab), rownames(overlaptab) )
	overlaptab$Direction_merged = NA
	overlaptab[a, "Direction_merged"] = ifelse(tab[a, "logFC.merged"] > 0,  "UP", "DOWN")
	overlaptab[a, "adj.P.Val.merged"] = tab[a, "adj.P.Val.merged"]
	overlaptab$Direction_meta = NA
	overlaptab[a, "Direction_meta"] = tab[a, "TestStatistic.meta"]
	overlaptab[is.na(overlaptab$Direction_meta), "Direction_meta"] =  0	
	overlaptab[overlaptab$Direction_meta>0, "Direction_meta"] =  "UP"
	overlaptab[overlaptab$Direction_meta<0, "Direction_meta"] =  "DOWN"
	overlaptab[overlaptab$Direction_meta==0, "Direction_meta"] =  NA	
	overlaptab[a, "adj.P.Val.meta"] = tab[a, "adj.P.Val.meta"]
	
	x = rowSums (overlaptab[,grepl("Direction", colnames(overlaptab))] == "UP")
	overlaptab$validated = NA
	overlaptab$validated[x %in% c(0,3)] = TRUE
	overlaptab$validated[x %in% c(1,2)] = FALSE
	overlaptab$validated = overlaptab$validated & (overlaptab$adj.P.Val.merged<=fdrCO & overlaptab$adj.P.Val.meta<=fdrCO)

	overlaptab = overlaptab[ order(overlaptab$adj.P.Val.merged) , ]
	volinia_overlap[[contrast]] = overlaptab
	write.table(overlaptab, 
            file=paste(outputdir, "/Volinia_validation_", contrast, postfix, sep=""),
            quote=FALSE, sep=separator, row.names=TRUE, col.names=NA)

	rm(x, overlaptab, contrast)
}

# write table2 in our article
table2 = consensustables[["DCIS-normal"]]
table2 = table2[table2$consensus,]
table2 = table2[table2$MIMAT %in% rownames( volinia_overlap[["DCIS-normal"]])[volinia_overlap[["DCIS-normal"]]$validated], ]
table2 = table2[order(table2$logFC.merged),2:6]
table2[,c(2,4)] = round(table2[,c(2,4)], 2)
write.table(table2, file=paste(articledir, "/table2", postfix, sep=""), sep=separator, col.names=NA, quote=FALSE)


```

And below is the result list from Volinia et al. with our results attached. First the "DCIS-normal" comparison. Rows are sorted by FDR from our "merged" approach. [Link to file](output-analysis/Volinia_validation_DCIS-normal.txt)

```{r results='asis'}
print( xtable( volinia_overlap[["DCIS-normal"]] , caption="microRNA found in Volinia compared to validation data", digits=3), 
      comment = FALSE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = FALSE)
```

<br/>
<br/>
And here is the same table for the "invasive-DCIS" comparison. [Link to file](output-analysis/Volinia_validation_invasive-DCIS.txt)

```{r results='asis'}
x = order(volinia_overlap[["invasive-DCIS"]]$adj.P.Val.merged)
print( xtable( volinia_overlap[["invasive-DCIS"]][x,] , caption="microRNA found in Volinia compared to validation data", digits=3), 
      comment = FALSE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = FALSE)

```
<br/>
<br/>


<br/>
<br/>

## Checking results towards a curated list of microRNA´s

Bastian Fromm and colleagues have carefully evaluated the evidence for the Human micro RNAs reported in mirBase and provided a classification based on this. In short, a lot of microRNAs in mirBASE and included in the microarray platforms are probably not real microRNAs.

A list of human microRNAs and their curation classification for our microRNAS is provided:

```{r}
	curatedfn = "curated_microRNA_MIMAT.csv"
  orgcuratedtab  = read.table(paste(annotdir, "/", curatedfn, sep=""), sep="\t", 
  												 header=TRUE, stringsAsFactors=FALSE, fill=TRUE,
                                     strip.white=TRUE, comment.char ="")
	orgcuratedtab$miRNA = paste("hsa-", orgcuratedtab$miRNA, sep="")
	
	# rearrange to a more practical object
	curatedtab = orgcuratedtab[,c(1,2,3)]
	names(curatedtab)[3]= "MIMAT"
	
	curatedtab = rbind(curatedtab, 
										 setNames( orgcuratedtab[,c(1,2,4)], names(curatedtab)),
										 setNames( orgcuratedtab[,c(1,2,5)], names(curatedtab)),
										 setNames( orgcuratedtab[,c(1,2,6)], names(curatedtab)) )
	curatedtab = curatedtab[curatedtab$MIMAT != "", ]

	table(orgcuratedtab$status)
```

The above counts are the microRNAs that were mapped to MIMAT IDs. 

The status labels explained:

- *purple*: equivocal - expression data lacking from one arm
- *rejected*: not a microRNA based on structure/read distribution
- *white*: a microRNA
- *yellow*: non-canonical microRNA

We want to check the curation status of our findings. Are our significant microRNAs real microRNAs? In addition as a quality control, it is useful to see the proportion of the statuses in the microRNAs that are filtered out and the ones retained.

Adding the curated status to the results, first the microRNAs found in Volinia et al.

```{r results='hold'}

for(n in names(volinia_overlap))
{
	x = unlist(lapply(rownames(volinia_overlap[[n]]), FUN=function(x)strsplit(x, "_")[[1]][1]))
	volinia_overlap[[n]]$curated = curatedtab[ match( x, curatedtab$MIMAT ), "status"]
	print( paste( n , names(table(volinia_overlap[[n]]$curated)), table(volinia_overlap[[n]]$curated)))
}
```
The microRNAs reported by Volinia et al. are all in the "for sure microRNA" list in Fromm et al.
<br/>
<br/>
And now the same assignment and summary for our results from the AHUS and METABRIC data sets.

```{r results='asis'}
namelists = list()

consensusresultsdir=paste(supplementaryfile1dir, "/consensuslists", sep="")
if(!file.exists(consensusresultsdir))
	dir.create(consensusresultsdir)
for(n in names(consensustables))
{
	x = unlist(lapply(rownames(consensustables[[n]]), FUN=function(x)strsplit(x, "_")[[1]][1])) # not neede anymore?
	consensustables[[n]]$curated = curatedtab[ match( x, curatedtab$MIMAT ), "status"]
	write.table( format( consensustables[[n]], digits=4), 
            file=paste(consensusresultsdir, "/consensusresults_",meta2merged[n, "comparisontype"], "__", n, postfix, sep=""),
            quote=FALSE, sep=separator, row.names=FALSE, col.names=TRUE)
	
	# for table3 and 4.
	dd = consensustables[[n]]
	dd = dd[dd$consensus & !is.na(dd$curated),]
	dd = dd[order(dd$logFC.merged, decreasing=TRUE), ]
	v = as.character(dd$name)
	v[dd$curated!="white"] = paste("(", v[dd$curated!="white"], ")", sep="")
	v[dd$logFC.merged>0] = paste( v[dd$logFC.merged>0], " +", sep="")
	v[dd$logFC.merged<0] = paste( v[dd$logFC.merged<0], " -", sep="")
	namelists[[n]]=v
	
}

# add a nice version of the sampleannotation to the suppl.
write.table(sampleannotation[,c("sample_id", "tissue_type", "pam50_est", "IHC", "iClust", "provider")], 
						file=paste(supplementaryfile1dir, "/sampleannotation_suppl", postfix, sep=""), sep=separator, 
						row.names=FALSE, col.names=TRUE)

# copy files made elsewhere to be included in suppl.
file.copy(from =list.files("input/additionalfile", full.names=TRUE), to=supplementaryfile1dir, overwrite=TRUE)

# write table3 and table4 in our article
tableclasses = c("LumA-DCIS", "LumB-DCIS", "Her2-DCIS", "Basallike-DCIS", "Normallike-DCIS")
nrows = max( unlist(lapply( namelists[tableclasses], FUN=length) ))
table3 = matrix("",ncol=length(tableclasses), nrow=nrows)
colnames(table3)=tableclasses
for(n in tableclasses)
	table3[1:length(namelists[[n]]), n] = namelists[[n]]
write.table(table3, file=paste(articledir, "/table3", postfix, sep=""), sep=separator, row.names=FALSE, quote=FALSE)

tableclasses = c("HER2pos_ERpos-DCIS", "HER2neg_ERpos-DCIS", "HER2pos_ERneg-DCIS", "HER2neg_ERneg_PGRneg-DCIS")
nrows = max( unlist(lapply( namelists[tableclasses], FUN=length) ))
table4 = matrix("",ncol=length(tableclasses), nrow=nrows)
colnames(table4)=tableclasses
for(n in tableclasses)
	if(length(namelists[[n]])>0)
		table4[1:length(namelists[[n]]), n] = namelists[[n]]
write.table(table4, file=paste(articledir, "/table4", postfix, sep=""), sep=separator, row.names=FALSE, quote=FALSE)

```

Result files for all the comparisons with p-values for the two approaches, and with the curation status added, are [here](output-analysis/consensus). The tables look like this (top of the DCIS-normal comparison as an example):

```{r results='asis'}
print( xtable( consensustables[["DCIS-normal"]][1:5,], caption="", digits=3), 
      comment = FALSE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
```

**Curation status for the significant microRNAs**
Below is a table with the counts of microRNAs in each curation class for the comparisons.
```{r results='asis'}
curclasses = unique(curatedtab$status)
curclasscounts = matrix(nrow=length(consensustables), ncol=length(curclasses)+1)
rownames(curclasscounts) = names(consensustables)
colnames(curclasscounts) = c(curclasses, "NA")
for(n in names(consensustables))
{
	a = consensustables[[n]]$consensus
	for(thisclass in curclasses)
		curclasscounts[n,thisclass] = sum(consensustables[[n]]$curated[a]==thisclass, na.rm =TRUE)
	curclasscounts[n,"NA"] = sum(is.na(consensustables[[n]]$curated[a]))
}
print( xtable( curclasscounts, caption="", digits=3), 
      comment = FALSE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)
```


<br/>
<br/>

**Differences in curation status for groups of microRNA**

The difference in curated status for the filtered out microRNAs and the ones kept as expressed, and the ones found as significantly differentially expressed between the "DCIS" and "normal" state are interesting at least from a quality control point of view.


```{r results='asis'}

filteredcommonMIMAT = consensustables[[1]]$MIMAT
unfilteredcommonMIMAT = miRNA2MIMAT$MIMAT[ !is.na(miRNA2MIMAT$UCAM) &
																		 !is.na(miRNA2MIMAT$AHUS) & 
																		 !miRNA2MIMAT$MIMAT %in% filteredcommonMIMAT]

filt1 = unlist(lapply(filteredcommonMIMAT, FUN=function(x)strsplit(x, "_")[[1]][1]))
unfilt1 = unlist(lapply(unfilteredcommonMIMAT, FUN=function(x)strsplit(x, "_")[[1]][1]))

expressed =	table(curatedtab$status[match(filt1, curatedtab$MIMAT)])
nonexpressed=	table(curatedtab$status[match(unfilt1[!unfilt1 %in% filt1],curatedtab$MIMAT) ])

significant = table(consensustables[["DCIS-normal"]]$curated[ consensustables[["DCIS-normal"]]$consensus])

print( xtable( rbind(nonexpressed,expressed,significant), caption="", digits=3), 
      comment = FALSE,
      type = "html",
      html.table.attributes="CELLPADDING=5",
      include.rownames = TRUE)


```

In the above table, *nonexpressed* is the number of micorRNAs that were filtered out in one or both of the platforms. The filter was mainly based on some expression threshold in a minimum amount of samples. For short these can be considered non-expressed. The *expressed* class consists of the microRNAs that passed the filter criteria in both platforms. The *significant* class is here the microRNAs that were found as significant in the "normal to DCIS"-comparison for the combined METABRIC and AHUS data sets.

<br/>
<br/>
<br/>

## Stratification based on iClust-subtypes

The UCAM samples are classified as an iClust-sub-type based on mRNA samples. This is provided as a sample annotation like the pam50 estimates. We will find differentially expressed microRNA between the DCIS samples and each of the iClust-types. This classification is only available for the UCAM data set and no alternative meta-analysis is done.



```{r}
iClust = sampleannotation$iClust
iClust[!is.na(iClust)] = paste("iClust", iClust[!is.na(iClust)], sep="")
iClust[sampleannotation$tissue_type=="DCIS"] = "DCIS"
to_be_used =  sampleannotation$tissue_type %in% c("DCIS", "invasive") &
	!is.na(iClust) & # do not use samples without clinical info
	sampleannotation$provider=="UCAM" 
table(iClust[to_be_used],sampleannotation[to_be_used,"tissue_type"], useNA="ifany")
```


The diff test,
```{r find_diff_genes_iClustlabels}

labels = unique(iClust[to_be_used & !iClust %in% c("", "unknown", "DCIS")])
contrasts = paste(labels, "-DCIS", sep="")

group = factor(iClust[to_be_used])

design = model.matrix(~0+group)
colnames(design) = gsub("group", "", colnames(design))
fit = lmFit(common_matrix[,to_be_used], design)
fit$genes$name = miRNA2MIMAT[rownames(common_matrix), "preferredname"]
fit$genes$MIMAT = rownames(common_matrix)
fit$genes$curated = curatedtab[ match( rownames(common_matrix), curatedtab$MIMAT ), "status"]
cont.matrix = makeContrasts ( contrasts=contrasts, levels=design)  
fit2 = contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)

iClustdifflistdir = paste(supplementaryfile1dir, "/difflists_iClust_UCAM_only", sep="")
if(!file.exists(iClustdifflistdir))
	dir.create(iClustdifflistdir)

iclustres = list()
for(thiscontrast in contrasts)
{
  thisres = topTable(fit2, coef=thiscontrast, adjust="BH", number=999)

  names(thisres)=gsub("^ID.", "", names(thisres))
  thisname= gsub("-", "-vs-", thiscontrast)
  thislabel = strsplit(thiscontrast, "-")[[1]][1]
	
  iclustres[[thislabel]] = thisres
  
  difflistfile=paste(iClustdifflistdir, "/difflist-iClust-",thisname, postfix, sep="")
  write.table(thisres, 
            file=difflistfile,
            quote=FALSE, sep=separator, row.names=FALSE, col.names=TRUE)
  print( paste("Diff genes with fdr<0.05 for ", thislabel, " vs DCIS: ",
               sum(thisres$adj.P.Val < 0.05), sep=""))
  
}
```
## Printing more tables and plots used in the article.

Creating table 7 from our article. All the microRNAs that are found to change both from normal to DCIS and further from DCIS to one of the sub-types of invasive. Also creating Figure 3 which highlights 4 microRNA.

```{r table7}

dcisDEG = as.character(subset(volinia_overlap[["DCIS-normal"]]$MIMATID_vol, volinia_overlap[["DCIS-normal"]]$validated))

table7 = data.frame(MIMA=character(0), name=character(0),  DCIS_direction=character(0),
										subtype=character(0), annottype=character(0), subtype_direction=character(0),
										stringsAsFactors=FALSE)


for(annot in c("pam50_est", "IHC"))
{
	for(lab in unique(sampleannotation[,annot]))
	{

		thislab = paste(lab, "-DCIS", sep="")
		a = consensustables[[thislab]]$consensus == TRUE &
				consensustables[[thislab]]$curated %in% c("purple", "white", "yellow")
		a = a & !is.na(a)
		commonDEG = intersect(consensustables[[thislab]]$MIMAT[a], dcisDEG)
		if(length(commonDEG) > 0)
		{
			df = data.frame( MIMAT = commonDEG,
										name=miRNA2MIMAT[commonDEG, "preferredname"],
										DCIS_direction=ifelse(consensustables[["DCIS-normal"]][commonDEG, "logFC.merged"] > 0, "UP", "DOWN" ),
										annottype=annot,
										subtype=lab,
										subtype_direction=ifelse(consensustables[[thislab]][commonDEG, "logFC.merged"] > 0, "UP", "DOWN" ),
										stringsAsFactors=FALSE
										)		
			table7=rbind(table7,df )
		}

	}
}

for(lab in names(iclustres))
{

		a = iclustres[[lab]]$adj.P.Val < fdrCO & iclustres[[lab]]$curated %in% c("purple", "white", "yellow")
		commonDEG = intersect( iclustres[[lab]]$MIMAT[a], dcisDEG)
		a = a & !is.na(a)
		if(length(commonDEG) > 0)
		{
			df = data.frame( MIMAT = commonDEG,
										name=miRNA2MIMAT[commonDEG, "preferredname"],
										DCIS_direction=ifelse(consensustables[["DCIS-normal"]][commonDEG, "logFC.merged"] > 0, "UP", "DOWN" ),
										annottype="iClust",
										subtype=lab,
										subtype_direction=ifelse(iclustres[[lab]][commonDEG, "logFC"] > 0, "UP", "DOWN" ),
										stringsAsFactors=FALSE
										)		
			table7=rbind(table7,df )
		}
}

nicetable7 = aggregate(subtype ~., table7[, -4], FUN=paste, collapse=" ")
nicetable7 = nicetable7[order(nicetable7$name),]
nicetable7 = nicetable7[order(nicetable7$DCIS_direction, decreasing=TRUE),]

write.table(nicetable7, paste(articledir, "/table7", postfix, sep=""), quote=TRUE, sep=separator, row.names=FALSE)

pdf(file=paste(supplementaryfile1dir, "/boxplots_table7microRNA.pdf", sep=""))

par(oma=c(0,0,2,0))
par(mfrow=c(2, 1))
par(mar=c(2, 2, 2, 0.5) + 0.1)
par(mgp = c(1.2, 0.2, 0))
boxplotcex = 1.25
for(thismimat in unique(table7$MIMAT))
{
	tmptab = 	table7[table7$MIMAT==thismimat,]
	
	for(p in unique(sampleannotation$provider))
	{
		datapoints = list()		
		datapoints[["normal"]] = common_matrix[thismimat, sampleannotation$tissue_type=="normal" & sampleannotation$provider==p ]
		datapoints[["DCIS"]] = common_matrix[thismimat, sampleannotation$tissue_type=="DCIS" & sampleannotation$provider==p ]
		boxcols = c("white", "grey85")
		
		for(i in 1:nrow(tmptab))
		{
			n = sampleannotation[,tmptab$annottype[i] ] == gsub("iClust", "", tmptab$subtype[i]) & sampleannotation$provider==p
			n = n & !is.na(n)
			if(sum(n)>0)
			{
				datapoints[[tmptab$subtype[i]]] = common_matrix[thismimat, n]
				boxcols = c(boxcols, "grey45")
			}																					 
		}
		
		boxplot(datapoints, ylab="Log2 processed signal", col=boxcols,  cex.axis=boxplotcex, cex.lab=0.7, yaxt="n", xaxt="n")
		axis(1, at=1:length(datapoints), labels=names(datapoints), cex.axis=boxplotcex, tick=FALSE)
		axis(2, cex.axis=0.7, tick=FALSE)
		legend("topright", legend=p, cex=boxplotcex, bty="n")
	}
	title(main=paste(thismimat, miRNA2MIMAT[thismimat, "preferredname"], sep=",   "),outer=T)
}
dev.off()




# Figure3, a subset of 4 microRNAS
pdf(file=paste(articledir, "/fig3.pdf", sep=""))

par(oma=c(0,0,0,0))
par(mfcol=c(4, 2))
par(mgp = c(1.2, 0.2, 0))
boxplotcex = 1
for(thismicroRNA in c("hsa-miR-193a-5p", "hsa-miR-378a-3p", "hsa-miR-342-3p", "hsa-miR-497-5p"))
{
	tmptab = 	table7[table7$name==thismicroRNA,]
	thismimat = tmptab$MIMAT[1]
	nicename = gsub("hsa-miR", "mir", thismicroRNA)
	
	for(p in unique(sampleannotation$provider))
	{
		datapoints = list()		
		datapoints[["normal"]] = common_matrix[thismimat, sampleannotation$tissue_type=="normal" & sampleannotation$provider==p ]
		datapoints[["DCIS"]] = common_matrix[thismimat, sampleannotation$tissue_type=="DCIS" & sampleannotation$provider==p ]
		boxcols = c("white", "grey85")
		
		for(i in 1:nrow(tmptab))
		{
			n = sampleannotation[,tmptab$annottype[i] ] == gsub("iClust", "", tmptab$subtype[i]) & sampleannotation$provider==p
			n = n & !is.na(n)
			if(sum(n)>0)
			{
				datapoints[[tmptab$subtype[i]]] = common_matrix[thismimat, n]
				boxcols = c(boxcols, "grey45")
			}																					 
		}
		if(p=="AHUS")
		{
				par(mar=c(1, 1, 2, 0.5) + 0.1)
				plottitle=nicename
		}else{
				par(mar=c(2, 1, 1, 0.5) + 0.1)
				plottitle=""
		}
		boxplot(datapoints, col=boxcols,  cex.axis=boxplotcex, cex.lab=0.7, yaxt="n", xaxt="n", main=plottitle, cex.main=2)
		axis(1, at=1:length(datapoints), labels=names(datapoints), cex.axis=boxplotcex, tick=FALSE)
		axis(2, cex.axis=0.7, tick=FALSE)
		legend("topright", legend=p, cex=1.5, bty="n")
	}
	#title(main=paste(thismimat, miRNA2MIMAT[thismimat, "preferredname"], sep=",   "),outer=T)
}
dev.off()


```


```{r sessionInfo, comment=""}
sessionInfo()
```

generation ended `r as.character(Sys.time())`. Time spent `r  as.integer(round(difftime(Sys.time(),starttime, units="mins")))` minutes .


