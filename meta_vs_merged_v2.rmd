---
title: "Meta vs Merged"
author: "Vegard Nygaard"
---

`r as.character(Sys.time())`
<br/>
<br/>

Just a very simple script to count and visualize the results from the two approaches of analysing the microRNA data, called **merged** and **meta**.
<BR/>
<BR/>
First, reading and formatting tables,

```{r}

metafilefolder = "lilianas/version2/t-test"
mergedfilefolder = "output-analysis-2014-11-20"
#metaresultfiles = list.files("lilianas/1000_permutations")
#mergedresultfiles = list.files("output-analysis-2014-08-05", pattern="difflist")

comparisons = c("DCIS-normal", "invasive-DCIS", "Normallike-DCIS", "LumA-DCIS", "LumB-DCIS", "Her2-DCIS", "Basallike-DCIS")

meta2merged = data.frame(metafn=character(0), mergedfn=character(0), direction=numeric(0), stringsAsFactors=FALSE)
meta2merged["DCIS-normal",] = list("DCIS_to_normal_test", "difflist-allmicroRNA-DCIS-vs-normal.txt",-1)
meta2merged["invasive-DCIS",] = list("DCIS_to_invasive_test", "difflist-allmicroRNA-invasive-vs-DCIS.txt",1)
meta2merged["Normallike-DCIS",] = list("DCIS_to_normal(invasive)_test", "difflist-allmicroRNA-pam50-Normallike-vs-DCIS.txt",1)
meta2merged["LumA-DCIS",] = list("DCIS_to_lumA_test", "difflist-allmicroRNA-pam50-LumA-vs-DCIS.txt",1)
meta2merged["LumB-DCIS",] = list("DCIS_to_lumB_test", "difflist-allmicroRNA-pam50-LumB-vs-DCIS.txt",1)
meta2merged["Her2-DCIS",] = list("DCIS_to_Her2_test", "difflist-allmicroRNA-pam50-Her2-vs-DCIS.txt",1)
meta2merged["Basallike-DCIS",] = list("basal_to_DCIS_test", "difflist-allmicroRNA-pam50-Basallike-vs-DCIS.txt",-1)

metatables = list()
mergedtables = list()
summarytab = data.frame( found_meta=integer(0),  found_merged=integer(0), 
                       found_both=integer(0),  stringsAsFactors=FALSE)

for(i in 1:nrow(meta2merged))
{   
    thiscomp = rownames(meta2merged)[i]
    fn = paste(metafilefolder, "/", meta2merged[thiscomp, "metafn"], sep="")
    thismetatab = read.table(fn, sep="\t", header=TRUE, stringsAsFactors=FALSE, fill=TRUE,
                                     strip.white=TRUE, comment.char ="")
    fn = paste(mergedfilefolder, "/", meta2merged[thiscomp, "mergedfn"], sep="")
    thismergedtab = read.table(fn, sep="\t", header=TRUE, stringsAsFactors=FALSE, fill=TRUE,
                                     strip.white=TRUE, comment.char ="", row.names=1)
    
    #harmonizing
    colnames(thismetatab)[colnames(thismetatab)=="FC"] = "logFC"
    rownames(thismetatab) = thismetatab$MIMAT
    thismetatab$logFC = thismetatab$logFC * meta2merged[thiscomp, "direction"]
  #summarytab[thiscomp, "metafile"] = rownames(thisrows)[1]
  #summarytab[thiscomp, "mergedfile"] = thisrows[1, "mergedfn"]

  summarytab[thiscomp, "found_meta"] = nrow(thismetatab)
  b = thismergedtab$adj.P.Val <= 0.05
  summarytab[thiscomp, "found_merged"] = sum(b)
  
  commonMIMATID = intersect( rownames(thismetatab),  rownames(thismergedtab)[b])
  summarytab[thiscomp, "found_both"] = sum( thismetatab[commonMIMATID, "logFC"] * thismergedtab[commonMIMATID, "logFC"] > 0) 
  rm(commonMIMATID)
  metatables[[thiscomp]] = thismetatab
  mergedtables[[thiscomp]] = thismergedtab
}

```
<br/>
<br/>
<br/>
The number of microRNAs found differentially expressed between states, according to the two approaches, also taking acount same direction in the overlap.
```{r}
print(summarytab[,1:3])
```
For several of the comparisons, the shorter list seems to be mostly included in the longer.
<br/>
<br/>
** QC plots**
The direct correlation between the calculated fold changes for the two approaches. Be aware that the foldchanges are not calculated for the meta approach and thus the comparisons are just as a quick qc to look for a huge mismatch.

```{r}
for(thiscomp in names(mergedtables))
{
  commonMIMATID = intersect( rownames(mergedtables[[thiscomp]]),  rownames(metatables[[thiscomp]]))
  plot(metatables[[thiscomp]][commonMIMATID, "logFC"], mergedtables[[thiscomp]][commonMIMATID, "logFC"],
       xlab="meta", ylab="merged", main=paste("Fold Change, log2 ", thiscomp, sep="") )
  legend("bottomright", legend=paste( summarytab[thiscomp ,1:3], names(summarytab)[1:3] ) )
  
}


```

These plots only use fold changes from microRNA that were found significant from the meta-analysis. The foldchanges from the non-significant microRNAs from the meta analysis are not reported and thus can not be compared to the merged fold changes. The "found" count, is microRNA with a FDR < 0.05.
<br/>
<br/>
<br/>
<br/>





